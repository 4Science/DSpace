image: maven:3.6.1

pipelines:
  branches:
    {'bitbucket-pipelines'}
    manual:
      - step:
          name: unit-test-code-checks
          size: 2x
          caches:
            - maven
          script:
            - mvn install -B -V -P-assembly -Pcoverage-report -Dtest.argLine=-Xmx2048m -DskipUnitTests=false -Pdspace-rest -Xmx1024M -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
      - step:
          name: integration-test
          size: 2x
          caches:
            - gradle
            - gradlewrapper
            - maven
          script:
            - ./dspace-api/src/test/data/dspaceFolder/bin/install_grobid.sh
            - mvn clean install license:check -DskipUnitTests=false -Pdspace-rest -DskipITs=false -Pdspace-rest -DskipIntegrationTests=false -P !assembly -B -V -Dsurefire.rerunFailingTestsCount=2

  pull-requests:
    manual:
      - step:
          name: unit-test-code-checks
          size: 2x
          caches:
            - maven
          script:
            - mvn install -B -V -P-assembly -Pcoverage-report -Dtest.argLine=-Xmx2048m -DskipUnitTests=false -Pdspace-rest -Xmx1024M -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
      - step:
          name: integration-test
          size: 2x
          caches:
            - gradle
            - gradlewrapper
            - maven
          script:
            - ./dspace-api/src/test/data/dspaceFolder/bin/install_grobid.sh
            - mvn clean install license:check -DskipUnitTests=false -Pdspace-rest -DskipITs=false -Pdspace-rest -DskipIntegrationTests=false -P !assembly -B -V -Dsurefire.rerunFailingTestsCount=2
  custom:
    manual:
       - step:
           size: 2x
           caches:
             - gradle
             - gradlewrapper
             - maven
           script:
             - ./dspace-api/src/test/data/dspaceFolder/bin/install_grobid.sh
             - mvn clean install license:check -DskipUnitTests=false -Pdspace-rest -DskipITs=false -Pdspace-rest -DskipIntegrationTests=false -P !assembly -B -V -Dsurefire.rerunFailingTestsCount=2

definitions:
  caches:
    gradlewrapper: ~/.gradle/wrapper