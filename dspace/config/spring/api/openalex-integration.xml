<?xml version="1.0" encoding="UTF-8"?>
<!--

    The contents of this file are subject to the license and copyright
    detailed in the LICENSE and NOTICE files at the root of the source
    tree and available online at

    http://www.dspace.org/license/

-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
       default-autowire-candidates="*Service,*DAO,javax.sql.DataSource">

    <context:annotation-config/>
    <!-- allows us to use spring annotations in beans -->

    <util:map id="openalexPublicationsMetadataFieldMap" key-type="org.dspace.importer.external.metadatamapping.MetadataFieldConfig"
              value-type="org.dspace.importer.external.metadatamapping.contributor.MetadataContributor">
        <description>Defines which metadatum is mapped on which metadatum. Note that while the key must be unique it
            only matters here for postprocessing of the value. The mapped MetadatumContributor has full control over
            what metadatafield is generated.
        </description>
        <entry key-ref="openalex.title" value-ref="openalexTitleContrib"/>
        <entry key-ref="openalex.abstract" value-ref="openalexAbstractContrib"/>
        <entry key-ref="openalex.publication.date" value-ref="openalexDateContrib"/>
        <entry key-ref="openalex.doi" value-ref="openalexDoiContrib"/>
        <entry key-ref="openalex.pmid" value-ref="openalexPmidContrib"/>
        <entry key-ref="openalex.openalexId" value-ref="openalexIdContrib"/>
        <entry key-ref="openalex.uri" value-ref="openalexUriIdentifierscContrib"/>
        <entry key-ref="openalex.author" value-ref="openalexAuthorContrib"/>
        <entry key-ref="openalex.author.orcid" value-ref="openalexAuthorOrcidContrib"/>
        <entry key-ref="openalex.language" value-ref="openalexLanguageContrib"/>
        <entry key-ref="openalex.publication.version" value-ref="openalexPublicationVersionContrib"/>
    </util:map>

    <bean id="openalexTitleContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.title"/>
        <property name="query" value="/title"/>
    </bean>
    <bean id="openalex.title" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.title"/>
    </bean>

    <bean id="openalexAbstractContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.abstract"/>
        <property name="metadataProcessor" ref="invertedIndexMetadataProcessor"/>
    </bean>
    <bean id="openalex.abstract" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.description.abstract"/>
    </bean>
    <bean name="invertedIndexMetadataProcessor" class="org.dspace.importer.external.metadatamapping.contributor.InvertedIndexProcessor">
        <property name="path" value="/abstract_inverted_index"/>
    </bean>

    <bean id="openalexDateContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.publication.date"/>
        <property name="metadataProcessor" ref="openalexDateMetadataProcessor"/>
    </bean>
    <bean name="openalexDateMetadataProcessor" class="org.dspace.importer.external.openalex.metadatamapping.OpenAlexDateMetadataProcessor">
        <property name="path" value="/publication_date"/>
    </bean>
    <bean id="openalex.publication.date" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.date.issued"/>
    </bean>

    <bean id="openalexDoiContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.doi"/>
        <property name="metadataProcessor" ref="openalexDoiMetadataProcessor"/>
    </bean>
    <bean name="openalexDoiMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/ids/doi"/>
        <property name="regexPattern" value="https://doi.org/"/>
        <property name="replacement" value=""/>
    </bean>
    <bean id="openalex.doi" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.doi"/>
    </bean>

    <bean id="openalexPmidContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.pmid"/>
        <property name="metadataProcessor" ref="openalexPmidMetadataProcessor"/>
    </bean>
    <bean name="openalexPmidMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/ids/pmid"/>
        <property name="regexPattern" value="https://pubmed.ncbi.nlm.nih.gov/"/>
        <property name="replacement" value=""/>
    </bean>
    <bean id="openalex.pmid" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.pmid"/>
    </bean>

    <bean id="openalexIdContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.openalexId"/>
        <property name="metadataProcessor" ref="openalexOpenAlexIdMetadataProcessor"/>
    </bean>
    <bean id="openalexOpenAlexIdMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/id" />
        <property name="regexPattern" value="^.*/"/>
        <property name="replacement" value=""/>
    </bean>
    <bean id="openalex.openalexId" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.other"/>
    </bean>

    <bean id="openalexMagContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.mag"/>
        <property name="query" value="/ids/mag"/>
    </bean>
    <bean id="openalex.mag" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.mag"/>
    </bean>

    <bean id="openalexAuthorContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.author"/>
        <property name="metadataProcessor" ref="openalexAuthorProcessor"/>
    </bean>
    <bean name="openalexAuthorProcessor" class="org.dspace.importer.external.metadatamapping.contributor.ArrayElementAttributeProcessor">
        <property name="pathToArray" value="/authorships"/>
        <property name="elementAttribute" value="/author/display_name"/>
    </bean>
    <bean id="openalex.author" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.contributor.author"/>
    </bean>

    <bean id="openalexAuthorOrcidContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.author.orcid"/>
        <property name="metadataProcessor" ref="openalexAuthorOrcidProcessor"/>
    </bean>
    <bean name="openalexAuthorOrcidProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.ArrayElementAttributeProcessor">
        <property name="pathToArray" value="/authorships"/>
        <property name="elementAttribute" value="/author/orcid"/>
    </bean>
    <bean id="openalex.author.orcid" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.orcid"/>
    </bean>

    <util:list id="contribList"
               value-type="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor"
               list-class="java.util.ArrayList">
        <ref bean="openalexUriLandingContrib"/>
        <ref bean="openalexUriPdfContrib"/>
    </util:list>

    <bean id="openalexUriIdentifierscContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.MultipleMetadataContributor">
        <property name="metadatumContributors" ref="contribList"/>
        <property name="field" ref="openalex.uri"/>
    </bean>
    <bean id="openalex.uri" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.uri"/>
    </bean>

    <bean id="openalexUriLandingContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.uri.landing"/>
        <property name="query" value="/best_oa_location/landing_page_url"/>
    </bean>
    <bean id="openalex.uri.landing" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.uri"/>
    </bean>

    <bean id="openalexUriPdfContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.uri.pdf"/>
        <property name="query" value="/best_oa_location/pdf_url"/>
    </bean>
    <bean id="openalex.uri.pdf" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier.uri"/>
    </bean>

    <bean name="openalexPublishedVersionMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/best_oa_location/version"/>
        <property name="regexPattern" value="publishedVersion"/>
        <property name="replacement" value="http://purl.org/coar/version/c_970fb48d4fbd8a85"/>
    </bean>
    <bean id="openalexPublishedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.publication.version"/>
        <property name="metadataProcessor" ref="openalexPublishedVersionMetadataProcessor"/>
    </bean>

    <bean name="openalexAcceptedVersionMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/best_oa_location/version"/>
        <property name="regexPattern" value="acceptedVersion"/>
        <property name="replacement" value="http://purl.org/coar/version/c_fa2ee174bc00049f"/>
    </bean>
    <bean id="openalexAcceptedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.publication.version"/>
        <property name="metadataProcessor" ref="openalexAcceptedVersionMetadataProcessor"/>
    </bean>

    <bean name="openalexSubmittedVersionMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/best_oa_location/version"/>
        <property name="regexPattern" value="submittedVersion"/>
        <property name="replacement" value="http://purl.org/coar/version/c_b1a7d7d4d402bcce"/>
    </bean>
    <bean id="openalexSubmittedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.publication.version"/>
        <property name="metadataProcessor" ref="openalexSubmittedVersionMetadataProcessor"/>
    </bean>

    <bean id="openalex.publication.version" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="oaire.version.volume"/>
    </bean>

    <bean id="openalexConditionalPublishedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.ConditionEqualJsonPathMetadataContributor">
        <property name="leftOperandProcessor" ref="openalexPublishedVersionMetadataProcessor"/>
        <property name="rightOperand" value="http://purl.org/coar/version/c_970fb48d4fbd8a85"/>
        <property name="metadatumContributor" ref="openalexPublishedVersionContrib"/>
    </bean>

    <bean id="openalexConditionalAcceptedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.ConditionEqualJsonPathMetadataContributor">
        <property name="leftOperandProcessor" ref="openalexAcceptedVersionMetadataProcessor"/>
        <property name="rightOperand" value="http://purl.org/coar/version/c_fa2ee174bc00049f"/>
        <property name="metadatumContributor" ref="openalexAcceptedVersionContrib"/>
    </bean>

    <bean id="openalexConditionalSubmittedVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.ConditionEqualJsonPathMetadataContributor">
        <property name="leftOperandProcessor" ref="openalexSubmittedVersionMetadataProcessor"/>
        <property name="rightOperand" value="http://purl.org/coar/version/c_b1a7d7d4d402bcce"/>
        <property name="metadatumContributor" ref="openalexSubmittedVersionContrib"/>
    </bean>

    <util:list id="versionContribList"
               value-type="org.dspace.importer.external.metadatamapping.contributor.ConditionEqualJsonPathMetadataContributor"
               list-class="java.util.ArrayList">
        <ref bean="openalexConditionalPublishedVersionContrib"/>
        <ref bean="openalexConditionalAcceptedVersionContrib"/>
        <ref bean="openalexConditionalSubmittedVersionContrib"/>
    </util:list>

    <bean id="openalexPublicationVersionContrib"
          class="org.dspace.importer.external.metadatamapping.contributor.MultipleMetadataContributor">
        <property name="metadatumContributors" ref="versionContribList"/>
        <property name="field" ref="openalex.publication.version"/>
    </bean>

    <bean id="openalexLanguageContrib" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.language"/>
        <property name="query" value="/language"/>
    </bean>
    <bean id="openalex.language" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.language.iso"/>
    </bean>

    <util:map id="openalexPersonMetadataFieldMap" key-type="org.dspace.importer.external.metadatamapping.MetadataFieldConfig"
              value-type="org.dspace.importer.external.metadatamapping.contributor.MetadataContributor">
        <description>Defines which metadatum is mapped on which metadatum. Note that while the key must be unique it
            only matters here for postprocessing of the value. The mapped MetadatumContributor has full control over
            what metadatafield is generated.
        </description>
        <entry key-ref="openalex.author.name" value-ref="openalexAuthorName"/>
        <entry key-ref="openalex.author.id" value-ref="openalexAuthorId"/>
    </util:map>

    <bean id="openalex.author.name" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.title"/>
    </bean>
    <bean id="openalexAuthorName" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.author.name"/>
        <property name="query" value="/display_name"/>
    </bean>


    <bean id="openalexAuthorId" class="org.dspace.importer.external.metadatamapping.contributor.SimpleJsonPathMetadataContributor">
        <property name="field" ref="openalex.author.id"/>
        <property name="metadataProcessor" ref="openalexAuthorMetadataProcessor"/>
    </bean>
    <bean id="openalexAuthorMetadataProcessor"
          class="org.dspace.importer.external.metadatamapping.contributor.RegexReplacingJsonPathMetadataProcessor">
        <property name="path" value="/id" />
        <property name="regexPattern" value="^.*/"/>
        <property name="replacement" value=""/>
    </bean>

    <bean id="openalex.author.id" class="org.dspace.importer.external.metadatamapping.MetadataFieldConfig">
        <constructor-arg value="dc.identifier"/>
    </bean>

</beans>
