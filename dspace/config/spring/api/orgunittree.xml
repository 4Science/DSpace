<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"
       default-autowire-candidates="*Service,*DAO,javax.sql.DataSource">


    <!-- OrgUnitTreeService -->
    <bean class="org.dspace.uniba.orgunittree.OrgunittreeService"
          autowire-candidate="true"
          scope="singleton">
        <property name="entity" value="OrgUnit" />
        <!-- condition on all orgunits -->
        <property name="generalcondition" ref="orgunit-readable-anonymous_filter" />
        <!-- condition to determine root entities -->
        <property name="rootcondition" ref="orgunit-has-no-parent-orgunit_filter" />
        <!-- Field for vertical relation -->
        <property name="verticalrelationfield" value="crisou.parentorgunit" />
        <!-- limit metrics solr query to anonymous readable results -->
        <property name="onlyAnonymous" value="true" />
        <property name="metricsconfiguration">
            <list>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="publications" />
                    <property name="query" value="oairecerif.author.affiliation_authority:{0} AND search.resourcetype:Publication" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="publicationsaggregated" />
                    <property name="query" value="publications" />
                    <property name="aggregate" value="true" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="product" />
                    <property name="query" value="oairecerif.author.affiliation_authority:{0} AND search.resourcetype:Product" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="productaggregated" />
                    <property name="query" value="product" />
                    <property name="aggregate" value="true" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="persons" />
                    <property name="query" value="person.affiliation.name_authority:{0} OR oairecerif.person.affiliation_authority:{0}" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="personsaggregated" />
                    <property name="query" value="persons" />
                    <property name="aggregate" value="true" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="projects" />
                    <property name="query" value="crispj.organization_authority:{0}" />
                </bean>
                <bean class="org.dspace.uniba.orgunittree.OrgunittreeMetricsConfiguration">
                    <property name="shortname" value="projectsaggregated" />
                    <property name="query" value="projects" />
                    <property name="aggregate" value="true" />
                </bean>
            </list>
        </property>

    </bean>

    <bean id="orgunit-has-no-parent-orgunit_filter" class="org.dspace.content.logic.DefaultFilter">
        <property name="statement">
            <bean class="org.dspace.content.logic.operator.Not">
                <property name="statements">
                    <ref bean="has-parent-orgunit" />
                </property>
            </bean>
        </property>
    </bean>

    <bean id="has-parent-orgunit" class="org.dspace.content.logic.condition.RequiredMetadataCondition">
        <property name="parameters">
            <map>
                <entry key="field" value="organization.parentOrganization" />
            </map>
        </property>
    </bean>

    <bean id="orgunit-readable-anonymous_filter" class="org.dspace.content.logic.DefaultFilter">
        <property name="statement">
            <ref bean="orgunit-readable-anon" />
        </property>
    </bean>

    <bean id="orgunit-readable-anon" class="org.dspace.content.logic.condition.ReadableByGroupCondition">
        <property name="parameters">
            <map>
                <entry key="group" value="Anonymous" />
                <entry key="action" value="READ" />
            </map>
        </property>
    </bean>

</beans>
