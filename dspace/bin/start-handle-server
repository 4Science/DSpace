#!/bin/sh
###########################################################################
# The contents of this file are subject to the license and copyright
# detailed in the LICENSE and NOTICE files at the root of the source
# tree and available online at
#
# http://www.dspace.org/license/
###########################################################################
# 'start-handle-server' script
# Unix shell script for starting Handle server.  WARNING this assumes any
# previously running Handle servers have been terminated.

# Assume that this script is in the bin subdirectory of the DSpace
# installation directory.
BINDIR=`dirname $0`
LOGGING_CONFIG=log4j2-handle-plugin.xml
LOG4J_CONFIGURATION_FILE=log4j2-handle-plugin.xml

# Read parameters from DSpace config
DSPACEDIR=`$BINDIR/dspace dsprop --property dspace.dir`
HANDLEDIR=`$BINDIR/dspace dsprop --property handle.dir`

# Assume log directory is a subdirectory of DSPACEDIR.
# If you want your handle server logs stored elsewhere, change this value
LOGDIR=$DSPACEDIR/log

#Allow user to specify java options through JAVA_OPTS variable
if [ "$JAVA_OPTS" = "" ]; then
  #Default Java to use 256MB of memory
  JAVA_OPTS=-Xmx256m
fi

# Remove lock file, in case the old Handle server did not shut down properly
rm -f $HANDLEDIR/txns/lock

# Unset JAVA_TOOL_OPTIONS (exported by Dockerfile) so that any debug ports don't conflict
unset JAVA_TOOL_OPTIONS
# Note, if you wish to also debug the Handle launcher, the following line is an
# example of how to do so - note the different port number and 'suspend=y' which
# means the JVM will not begin execution until a debugger is attached.
#JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:1044"

# Start the Handle server, with a special log4j properties file.
# We cannot simply write to the same logs, since log4j
# does not support more than one JVM writing to the same rolling log.
nohup java $JAVA_OPTS \
    -Ddspace.log.init.disable=true \
    -classpath `$BINDIR/dspace classpath` \
    net.handle.server.Main $HANDLEDIR \
    </dev/null >> $LOGDIR/handle-server.log 2>&1 &
